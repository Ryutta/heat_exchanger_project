---
title: "Analysis_1st"
author: "Ryuta"
date: "2026-01-05"
output: html_document
---

# 目的

熱交換器の詰まり本数と各運転パラメータ（U値、ジャケット圧、ポンプ圧）の相関関係を分析し、詰まりの発生要因を特定することを目的とする。

```{r install_packages, message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}
## 環境構築
install.packages("pacman")
install.packages("GGally")
install.packages("ggplot2")
install.packages("e1071")
install.packages("readxl")
install.packages("gt")
install.packages("ggpubr")
install.packages("dygraphs")
install.packages("xts")
```

## ロード

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(dplyr)
library(lubridate) # 日付計算（%m-% や months()）のために必要
library(gt)
library(ggpubr)
library(DT)
library(dygraphs)
library(xts)
knitr::opts_chunk$set(echo=FALSE) # 全てのコードチャンクに適用されるオプション
```

## 関数定義

```{r}
# キャンペーンごとの最大値（初期・末期）を取得する関数
get_campaign_max <- function(df, target_col) {

  extract_stats <- function(sub_df, type_label) {
    sub_df |>
      group_by(Period) |>
      filter(
        if (type_label == "End") {
           Timestamp >= (max(Timestamp) %m-% months(1)) & Timestamp <= max(Timestamp)
        } else {
           Timestamp >= min(Timestamp) & Timestamp <= (min(Timestamp) %m+% months(1))
        }
      ) |>
      summarize(
        Max_Value = if_else(all(is.na(.data[[target_col]])), NA_real_, max(.data[[target_col]], na.rm = TRUE)),
        Reference_Date = if (type_label == "End") max(Timestamp) else min(Timestamp),
        .groups = 'drop'
      ) |>
      mutate(Type = type_label)
  }

  df_valid <- df |> filter(!is.na(.data[[target_col]]))

  df_end <- extract_stats(df_valid, "End")
  df_beg <- extract_stats(df_valid, "Beginning")

  bind_rows(df_end, df_beg) |>
    mutate(PeriodType = str_c(Period, Type, sep = "_"))
}

# 分析・可視化を行う関数
analyze_and_report <- function(df_outcome, df_stuck, x_var, x_label) {
  # 結合
  df_final <- left_join(df_outcome, df_stuck, by = "PeriodType") |>
    filter(!is.na(NoS)) |>
    mutate(Time_Category = if_else(Reference_Date < as.POSIXct("2021-10-01"), "Before Sep 2021", "After Sep 2021"))

  # データテーブル表示
  print(datatable(df_final))

  # プロット作成
  p <- df_final |>
    ggplot(aes(x = .data[[x_var]], y = NoS, color = Time_Category)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    stat_cor(method = "pearson", label.x.npc = "left", label.y.npc = "top") +
    geom_text(aes(label = PeriodType),
              vjust = -1,
              size = 3.5,
              check_overlap = FALSE,
              show.legend = FALSE) +
    labs(x = x_label, y = "NoS") +
    theme_bw() +
    theme(
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    ) +
    expand_limits(y = max(df_final$NoS) * 1.1)

  print(p)

  # 回帰分析
  x_val <- as.matrix(df_final |> select(all_of(x_var)))
  y_val <- as.matrix(df_final |> select(NoS))
  reg <- lm(y_val ~ x_val)
  print(summary(reg))

  return(invisible(df_final))
}
```

## 使用データ

```{r}
df_raw <- read_xlsx("data/20251210_u_value.xlsx", sheet = 1, guess_max = 3000)
df_raw <- df_raw |>
  filter(Timestamp >= as.POSIXct("2021-02-01 00:00:00"))

df_Stuck <- read_xlsx("data/NoS_20251201.xlsx", sheet = 1)
df_Stuck <- df_Stuck |>
  filter(Period != "2502") |>
  mutate(PeriodType = str_c(Period, `b/e`, sep = "_")) # 結合キーをここで作成
```

## データ読み込み

### 時系列データ

```{r, echo=FALSE}
datatable(df_raw)
```

### 詰まりデータ

```{r}
datatable(df_Stuck)
```

## パラメータ推移

各運転パラメータの時系列推移を確認する。

### U値

```{r}
# xtsオブジェクトへの変換
ts_u <- xts(df_raw$U, order.by = df_raw$Timestamp)
# プロット
dygraph(ts_u, main = "U Value Trend") |>
  dyRangeSelector()
```

### ジャケット圧

```{r}
ts_jacket <- xts(df_raw$jacket_P, order.by = df_raw$Timestamp)
dygraph(ts_jacket, main = "Jacket Pressure Trend") |>
  dyRangeSelector()
```

### ポンプ圧

```{r}
ts_pump <- xts(df_raw$pump_outlet, order.by = df_raw$Timestamp)
dygraph(ts_pump, main = "Pump Outlet Pressure Trend") |>
  dyRangeSelector()
```

## データ加工と分析

各パラメータ（U値、ジャケット圧、ポンプ圧）について、キャンペーンの初期・末期の最大値を抽出し、詰まり本数（NoS）との相関を分析する。

### Case1) UA

U値の最大値からUAを算出し、相関を確認する。

```{r}
# 1. データ抽出
df_outcome_u <- get_campaign_max(df_raw, "U")

# 2. UA列の追加 (Max_U * 367)
df_outcome_u <- df_outcome_u |>
  mutate(UA = Max_Value * 367)

# 3. 分析実行
analyze_and_report(df_outcome_u, df_Stuck, "UA", "UA")
```

### Case2) ジャケット圧

ジャケット圧（jacket_P）の最大値と詰まり本数の相関を確認する。

```{r}
# 1. データ抽出
df_outcome_jacket <- get_campaign_max(df_raw, "jacket_P")

# 2. 分析実行
analyze_and_report(df_outcome_jacket, df_Stuck, "Max_Value", "JacketP")
```

### Case3) ポンプ圧

ポンプ吐出圧（pump_outlet）の最大値と詰まり本数の相関を確認する。

```{r}
# 1. データ抽出
df_outcome_pump <- get_campaign_max(df_raw, "pump_outlet")

# 2. 分析実行
analyze_and_report(df_outcome_pump, df_Stuck, "Max_Value", "Max_P")
```

### 評価

本分析の結果、各パラメータと詰まり本数の間に一定の相関傾向が確認された。特に2021年9月以前と以後で傾向に違いが見られるケースがあるため、時期を考慮した監視が重要であると考えられる。

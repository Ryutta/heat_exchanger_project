# 総括伝熱係数 (U) の算出方法

メジャー `U` は、PIシステムから取得された複数のデータタグ（流量、温度、圧力）を基に、以下のステップで算出されています。

## 1. 使用されている PI タグ一覧

| タグ名 | 説明 | 用途 |
| :--- | :--- | :--- |
| **M2FC4403.PV** | 蒸気流量 | 熱量 `q` の算出 |
| **M2TI4405.PV** | プロセス入口温度 | 温度 `t1` および `t2` の算出 |
| **M2PI4410W.PV** | ジャケット圧力 | 加熱源温度 `t3_t4` の算出 |
| **M2PI4407.PV** | ポンプ入口圧力 | ポンプ揚程（`lifting_height`）の算出 |
| **M2PI4411W.PV** | ポンプ出口圧力 | ポンプ揚程（`lifting_height`）の算出 |

---

## 2. 算出ステップと計算式

### ステップ 1: 熱量 `q` の算出
蒸気流量からプロセスに与えられた熱量を計算します。
- **タグ:** `M2FC4403.PV`
- **計算式:** `AVERAGE(M2FC4403.PV) * 2257.05 * 1000 / 3600 / 1000`
  - `2257.05`: 蒸発潜熱 (kJ/kg) と推測。

### ステップ 2: ポンプ流量 `pump_flow` の算出
ポンプの性能曲線（二次式）を用いて、差圧から流量を推定します。

#### ① ポンプ入口圧力 (`pump_inlet`)
- **タグ:** `M2PI4407.PV`
- **計算式:** `(M2PI4407.PV / 760 * 101.325) + (950 * 9.81 * (1.4 + 6.125) / 1000)`
  - 単位換算（mmHg → kPa）と位置水頭の補正が含まれています。

#### ② ポンプ出口圧力 (`pump_outlet`)
- **タグ:** `M2PI4411W.PV`
- **計算式:** `M2PI4411W.PV + 101.325`
  - ゲージ圧から絶対圧への変換。

#### ③ ポンプ揚程 (`lifting_height`)
- **計算式:** `([pump_outlet] - [pump_inlet]) * 1000 / 9.81 / 950`

#### ④ ポンプ流量 (`pump_flow`)
揚程 `x` を変数とする二次方程式で流量を算出します。
- **計算式:** `(-0.6857 * x^2 + 0.8571 * x + 43.589) * 60 * 950 / 1000`

### ステップ 3: 温度差の算出 (`t1`, `t2`, `t3_t4`)
対数平均温度差 (LMTD) を求めるための各点の温度を算出します。

#### ① 入口温度 `t1`
- **タグ:** `M2TI4405.PV`
- **計算式:** `AVERAGE(M2TI4405.PV)`

#### ② 出口温度 `t2`
- **計算式:** `t1 + [q] * 1000 / ([pump_flow] * 1000 / 3600) / 2.09`
  - `2.09`: 比熱 (kJ/kg・K) と推測。

#### ③ 加熱源温度 `t3_t4` (飽和蒸気温度)
- **タグ:** `M2PI4410W.PV`
- **計算式:** `27.838 * LN([jacket_P] + 101.325) - 28.559`

### ステップ 4: 対数平均温度差 `_delta_tlm` (LMTD)
- **計算式:** `(_dT1 - _dT2) / LN(_dT1 / _dT2)`
  - `_dT1 = t3_t4 - t1`
  - `_dT2 = t3_t4 - t2`

---

## 3. 最終的な U の算出

以上の値を組み合わせて、総括伝熱係数 `U` を算出します。

```dax
U = DIVIDE([q] * 1000 * 1000 / 367, [_delta_tlm], 0)
```
- `367`: 伝熱面積 (A) に相当する定数と推測されます。
